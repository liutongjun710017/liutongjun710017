<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«ä»½è®¤è¯ç³»ç»Ÿ - è”é‚¦æ²™å‹’è°ƒæŸ¥å±€</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Microsoft YaHei',sans-serif;background:linear-gradient(135deg,#1a1a2e,#16213e);color:white;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
        .container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:30px;width:100%;max-width:500px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2)}
        .header{text-align:center;margin-bottom:30px}
        .header h1{font-size:24px;margin-bottom:8px;background:linear-gradient(45deg,#00b4db,#0083b0);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .nfc-section{text-align:center;margin-bottom:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:10px;border:1px solid rgba(255,255,255,0.1)}
        .nfc-button{background:linear-gradient(45deg,#00b4db,#0083b0);color:white;border:none;padding:12px 24px;border-radius:25px;font-size:16px;cursor:pointer;margin:10px 5px;transition:transform 0.2s}
        .nfc-button:hover{transform:scale(1.05)}
        .nfc-button:disabled{background:#666;cursor:not-allowed}
        .nfc-status{font-size:14px;color:#ffa726;margin-top:10px;min-height:20px}
        .status-item{display:flex;justify-content:space-between;align-items:center;padding:15px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-size:16px}
        .label{font-weight:bold;color:#cccccc}
        .value{font-weight:bold}
        .checking{color:#ffa726}
        .checking::after{content:'...';animation:dots 1.5s infinite}
        .verified{color:#4caf50;position:relative}
        .verified::after{content:' âœ“';color:#4caf50;font-weight:bold}
        .unauthorized{color:#f44336;position:relative}
        .unauthorized::after{content:' âœ—';color:#f44336;font-weight:bold}
        .loading-bar{width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin:20px 0;overflow:hidden}
        .loading-progress{height:100%;background:linear-gradient(90deg,#00b4db,#0083b0);border-radius:2px;width:0%;transition:width 0.5s ease}
        @keyframes dots{0%,20%{content:'.'}40%{content:'..'}60%,100%{content:'...'}}
        .footer{text-align:center;margin-top:20px;font-size:12px;color:#888}
        .card-info{background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-top:10px;font-size:12px;color:#ccc}
        .card-id{color:#00b4db;font-family:monospace;background:rgba(0,180,219,0.1);padding:2px 6px;border-radius:4px}
        .test-buttons{display:flex;gap:10px;justify-content:center;margin:10px 0;flex-wrap:wrap}
        .test-button{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:white;padding:8px 12px;border-radius:5px;cursor:pointer;font-size:11px;flex:1;min-width:80px;max-width:120px}
        .test-button:hover{background:rgba(255,255,255,0.2)}
        .error-message{color:#ff6b6b;font-size:12px;margin-top:5px}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” èº«ä»½è®¤è¯ç³»ç»Ÿ</h1>
            <p>è”é‚¦æ²™å‹’è°ƒæŸ¥å±€ - å®‰å…¨éªŒè¯</p >
        </div>
        
        <div class="nfc-section">
            <div>è¯·å°†NFCå¡ç‰‡é è¿‘è®¾å¤‡</div>
            <button class="nfc-button" onclick="startNFCScan()" id="nfcButton">å¼€å§‹NFCæ‰«æ</button>
            <div class="nfc-status" id="nfcStatus">ç­‰å¾…æ‰«æ...</div>
            <div id="nfcError" class="error-message"></div>
            
            <div class="test-buttons" id="testButtonsContainer">
                <button class="test-button" onclick="testCard('se 710017')">Senseiå¡</button>
                <button class="test-button" onclick="testCard('xy 214412')">å­¦ç”Ÿå¡</button>
                <button class="test-button" onclick="testCard('')">ç©ºç™½å¡</button>
            </div>
            
            <div class="card-info" id="cardInfo"></div>
        </div>
        
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        
        <div id="statusDisplay">
            <div class="status-item">
                <span class="label">CAR IDï¼š</span>
                <span class="value checking" id="cardIdStatus">ç­‰å¾…è¯»å–</span>
            </div>
            
            <div class="status-item">
                <span class="label">IDå¡å·ï¼š</span>
                <span class="value checking" id="idNumberStatus">ç­‰å¾…è¯»å–</span>
            </div>
            
            <div class="status-item">
                <span class="label">å§“åï¼š</span>
                <span class="value checking" id="nameStatus">ç­‰å¾…NFCéªŒè¯</span>
            </div>
            
            <div class="status-item">
                <span class="label">éš¶å±ï¼š</span>
                <span class="value checking" id="affiliationStatus">ç­‰å¾…NFCéªŒè¯</span>
            </div>
            
            <div class="status-item">
                <span class="label">æƒé™ç­‰çº§ï¼š</span>
                <span class="value checking" id="levelStatus">ç­‰å¾…NFCéªŒè¯</span>
            </div>
            
            <div class="status-item">
                <span class="label">åŒºåŸŸè®¤è¯ï¼š</span>
                <span class="value checking" id="areaStatus">ç­‰å¾…NFCéªŒè¯</span>
            </div>
        </div>
        
        <!-- ç®¡ç†å‘˜åå°ç³»ç»Ÿå…¥å£ -->
        <div class="admin-verify" id="adminVerify" style="text-align:center; margin-top:25px;">
            <button class="nfc-button" onclick="showAdminVerify()" style="background:linear-gradient(45deg,#ff9800,#f57c00);">
                ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜åå°
            </button>
            <div style="font-size:11px; color:#888; margin-top:5px;">åŒ…å«ï¼šæ‰‹åŠ¨æµ‹è¯•ã€åˆ›å»ºæ–°å¡ã€æŸ¥çœ‹å¡åº“</div>
        </div>
    <!-- ç®¡ç†å‘˜åå°ç³»ç»Ÿç•Œé¢ (é»˜è®¤éšè—) -->
    <div class="admin-section" id="adminSection" style="display:none; margin-top:20px; padding:20px; background:rgba(255,255,255,0.05); border-radius:10px; border:1px solid rgba(255,255,255,0.1);">
        <h3 style="text-align:center; margin-bottom:15px; color:#00b4db;">ğŸ‘¨â€ğŸ’¼ ç®¡ç†å‘˜åå°ç³»ç»Ÿ</h3>
        
        <!-- æ‰‹åŠ¨æµ‹è¯•é¢æ¿ -->
        <div style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.03); border-radius:8px;">
            <h4 style="color:#ccc; margin-bottom:10px;">ğŸ› ï¸ æ‰‹åŠ¨æµ‹è¯•å¡ç‰‡</h4>
            <input type="text" class="manual-input" id="manualCardId" placeholder="è¾“å…¥å¡å·è¿›è¡Œæµ‹è¯•ï¼Œå¦‚ï¼šse 710017" style="width:100%; margin-bottom:10px;">
            <button class="nfc-button" onclick="manualTest()" style="width:100%; background:linear-gradient(45deg,#9c27b0,#6a1b9a);">æ‰§è¡Œæ‰‹åŠ¨éªŒè¯</button>
            <div id="manualTestStatus" style="margin-top:10px; font-size:12px;"></div>
        </div>
        
        <!-- å·²å‚¨å­˜å¡ç‰‡åˆ—è¡¨ -->
        <div style="margin-bottom:20px;">
            <h4 style="color:#ccc; margin-bottom:10px;">ğŸ“ å·²å‚¨å­˜çš„èº«ä»½å¡ç‰‡</h4>
            <div id="storedCardsList" style="background:rgba(0,0,0,0.2); padding:10px; border-radius:5px; max-height:200px; overflow-y:auto; font-size:12px; font-family:monospace; min-height:60px;">
                åŠ è½½ä¸­...
            </div>
        </div>
        
        <!-- åˆ›å»ºæ–°å¡ç‰‡é¢æ¿ -->
        <div style="padding:15px; background:rgba(255,255,255,0.03); border-radius:8px;">
            <h4 style="color:#ccc; margin-bottom:15px;">âœ¨ åˆ›å»ºæ–°å­¦ç”Ÿæ¡£æ¡ˆ</h4>
            <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:3px; color:#ccc; font-size:13px;">å¡å· (å°†å†™å…¥NFCæ ‡ç­¾):</label>
                <input type="text" class="manual-input" id="newCardId" placeholder="ä¾‹å¦‚ï¼šSTUDENT-002" style="font-size:14px;">
            </div>
            <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:3px; color:#ccc; font-size:13px;">å§“å:</label>
                <input type="text" class="manual-input" id="newName" placeholder="ä¾‹å¦‚ï¼šå­¦ç”ŸBï¼štrue" style="font-size:14px;">
            </div>
            <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:3px; color:#ccc; font-size:13px;">å­¦é™¢:</label>
                <input type="text" class="manual-input" id="newAffiliation" placeholder="ä¾‹å¦‚ï¼šé˜¿æ‹œå¤šæ–¯é«˜ç­‰å­¦é™¢ï¼štrue" style="font-size:14px;">
            </div>
            <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:3px; color:#ccc; font-size:13px;">æƒé™ç­‰çº§:</label>
                <input type="text" class="manual-input" id="newLevel" placeholder="ä¾‹å¦‚ï¼šR-Stdï¼štrue" style="font-size:14px;">
            </div>
            <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:3px; color:#ccc; font-size:13px;">åŒºåŸŸè®¤è¯:</label>
                <input type="text" class="manual-input" id="newArea" placeholder="ä¾‹å¦‚ï¼šé˜¿æ‹œå¤šæ–¯" style="font-size:14px;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:3px; color:#ccc; font-size:13px;">IDå¡å·:</label>
                <input type="text" class="manual-input" id="newIdNumber" placeholder="ä¾‹å¦‚ï¼šABXY-002" style="font-size:14px;">
            </div>
            <button class="nfc-button" onclick="saveNewCard()" style="background:linear-gradient(45deg,#4caf50,#2e7d32); width:100%;">
                ğŸ’¾ ä¿å­˜æ–°å­¦ç”Ÿæ¡£æ¡ˆ
            </button>
            <div id="saveStatus" style="margin-top:10px; font-size:12px;"></div>
        </div>
        
        <div style="text-align:center; margin-top:15px;">
            <button class="nfc-button" onclick="exitAdminMode()" style="background:linear-gradient(45deg,#757575,#424242); font-size:14px; padding:8px 20px;">
                â¬… é€€å‡ºç®¡ç†å‘˜æ¨¡å¼
            </button>
        </div>
    </div>
    
    <div class="footer">
        <p>æœ€åæ›´æ–°: <span id="timestamp"></span></p >
    </div>
</div>
<script>
    // æ›´æ–°æ—¶é—´æˆ³
    document.getElementById('timestamp').textContent = new Date().toLocaleString('zh-CN');
    
    // ==================== NFCå¡ç‰‡æ•°æ®åº“ ====================
    const nfcCards = {
        "se 710017": {
            name: 'Sensei',
            affiliation: 'è”é‚¦æ²™å‹’è°ƒæŸ¥å±€',
            level: 'WTR',
            area: 'é˜¿æ‹œå¤šæ–¯',
            idNumber: 'SE-710017',
            type: 'å®˜æ–¹è®¤è¯'
        },
        "xy 214412": {
            name: 'å°é¸Ÿæ¸¸æ˜ŸåŸï¼štrue',
            affiliation: 'é˜¿æ‹œå¤šæ–¯é«˜ç­‰å­¦é™¢ï¼štrue',
            level: 'R-Stdï¼štrue',
            area: 'é˜¿æ‹œå¤šæ–¯',
            idNumber: 'xy 214412',
            type: 'å­¦ç”Ÿè®¤è¯'
        }
    };

    // ==================== ç®¡ç†å‘˜éªŒè¯ç³»ç»Ÿ ====================
    const ADMIN_KEY = "ADM-001710017ndbhcihbsnvdhdbscjsbsbsbjdhdcnsbbkbhdbjxvnsshjfsbbevdjhdbwkbwgdugdkeb";
    let isAdminVerified = false;
    let adminNdefReader = null;

    const loadingProgress = document.getElementById('loadingProgress');
    let ndefReader = null;

    // åˆå§‹åŒ–æµ‹è¯•æŒ‰é’®
    function initializeTestButtons() {
        const testButtonsContainer = document.getElementById('testButtonsContainer');
        // åªæ˜¾ç¤ºéç®¡ç†å‘˜å¡ç‰‡çš„æµ‹è¯•æŒ‰é’®
        Object.keys(nfcCards).forEach(cardId => {
            if (cardId !== ADMIN_KEY) {
                const button = document.createElement('button');
                button.className = 'test-button';
                button.textContent = cardId.length > 8 ? cardId.substring(0, 8) + '...' : cardId;
                button.title = cardId;
                button.onclick = function() { 
                    testCard(cardId);
                };
                // æ’å…¥åˆ°ç©ºç™½å¡æŒ‰é’®ä¹‹å‰
                const blankBtn = testButtonsContainer.querySelector('.test-button[onclick*="testCard(\'\')"]');
                if(blankBtn) {
                    testButtonsContainer.insertBefore(button, blankBtn);
                } else {
                    testButtonsContainer.appendChild(button);
                }
            }
        });
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initializeTestButtons();
    });// ==================== ç®¡ç†å‘˜åå°åŠŸèƒ½ ====================
// æ˜¾ç¤ºç®¡ç†å‘˜éªŒè¯ç•Œé¢
function showAdminVerify() {
    const nfcStatus = document.getElementById('nfcStatus');
    const cardInfo = document.getElementById('cardInfo');
    
    nfcStatus.textContent = 'è¯·æ‰«æç®¡ç†å‘˜å¯†é’¥å¡ç‰‡...';
    nfcStatus.style.color = '#ff9800';
    cardInfo.innerHTML = 'éœ€è¦éªŒè¯ç®¡ç†å‘˜æƒé™<br>è¯·å°†ç®¡ç†å‘˜å¯†é’¥NFCæ ‡ç­¾é è¿‘è®¾å¤‡';
    cardInfo.style.color = '#ff9800';
    
    stopNFCScan();
    startAdminNFCScan();
}

// ç®¡ç†å‘˜NFCæ‰«æ
async function startAdminNFCScan() {
    const nfcButton = document.getElementById('nfcButton');// ==================== NFCæ ¸å¿ƒåŠŸèƒ½ ====================
// NFCæ‰«æå‡½æ•°
async function startNFCScan() {
    const nfcStatus = document.getElementById('nfcStatus');
    const nfcButton = document.getElementById('nfcButton');
    const nfcError = document.getElementById('nfcError');
    
    if (!('NDEFReader' in window)) {
        nfcStatus.textContent = 'âŒ æ­¤æµè§ˆå™¨ä¸æ”¯æŒWeb NFC API';
        nfcError.textContent = 'è¯·ä½¿ç”¨ Chrome for Android æˆ–å…¶ä»–æ”¯æŒWeb NFCçš„æµè§ˆå™¨';
        return;
    }

    try {
        nfcButton.disabled = true;
        nfcStatus.textContent = 'è¯·å°†å¡ç‰‡é è¿‘è®¾å¤‡...';
        nfcError.textContent = '';
        ndefReader = new NDEFReader();
        await ndefReader.scan();
        nfcStatus.textContent = 'æ‰«æä¸­...å°†å¡ç‰‡é è¿‘è®¾å¤‡';
        
        ndefReader.onreading = event => {
            const decoder = new TextDecoder();
            let cardId = '';
            for (const record of event.message.records) {
                if (record.recordType === "text") {
                    cardId = decoder.decode(record.data);
                    break;
                }
            }
            nfcStatus.textContent = `è¯»å–åˆ°å¡ç‰‡æ•°æ®`;
            processNFCCard(cardId);
        };

        ndefReader.onreadingerror = event => {
            nfcStatus.textContent = 'âŒ è¯»å–å¡ç‰‡å¤±è´¥';
            nfcError.textContent = 'è¯·é‡æ–°å°è¯•é è¿‘å¡ç‰‡';
            nfcButton.disabled = false;
        };

    } catch (error) {
        nfcStatus.textContent = 'âŒ NFCæ‰«æå¯åŠ¨å¤±è´¥';
        nfcError.textContent = error.message;
        nfcButton.disabled = false;
    }
}

function stopNFCScan() {
    if (ndefReader) {
        ndefReader.onreading = null;
        ndefReader.onreadingerror = null;
        ndefReader = null;
    }
    if (adminNdefReader) {
        adminNdefReader.onreading = null;
        adminNdefReader.onreadingerror = null;
        adminNdefReader = null;
    }
    document.getElementById('nfcButton').disabled = false;
}

function testCard(cardId) {
    document.getElementById('manualCardId').value = cardId;
    stopNFCScan();
    processNFCCard(cardId);
}

// å¤„ç†NFCå¡ç‰‡ (å…³é”®ä¿®æ”¹ï¼šæ™®é€šéªŒè¯æ—¶éšè—å¡å·)
function processNFCCard(cardId) {
    const nfcStatus = document.getElementById('nfcStatus');
    const cardInfo = document.getElementById('cardInfo');
    resetAllStatus();
    document.getElementById('nfcButton').disabled = false;
    loadingProgress.style.width = '25%';

    // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜å¯†é’¥
    if (cardId === ADMIN_KEY) {
        nfcStatus.textContent = 'ğŸ”‘ ç®¡ç†å‘˜å¯†é’¥å·²éªŒè¯';
        nfcStatus.style.color = '#9c27b0';
        cardInfo.innerHTML = 'æ­¤å¯†é’¥ç”¨äºåå°ç®¡ç†éªŒè¯';
        cardInfo.style.color = '#9c27b0';
        loadingProgress.style.width = '100%';
        return;
    }

    if (!cardId || cardId.trim() === '') {
        nfcStatus.textContent = 'âŒ è¯»å–åˆ°ç©ºç™½æ ‡ç­¾';
        nfcStatus.style.color = '#f44336';
        cardInfo.innerHTML = 'æ ‡ç­¾ä¸­æ²¡æœ‰å­˜å‚¨æ–‡æœ¬æ•°æ®';
        cardInfo.style.color = '#f44336';
        // å…³é”®ä¿®æ”¹ï¼šä¸æ˜¾ç¤ºå…·ä½“å¡å·ï¼Œåªæ˜¾ç¤ºçŠ¶æ€
        document.getElementById('cardIdStatus').textContent = 'ç©ºç™½æ ‡ç­¾';
        document.getElementById('cardIdStatus').className = 'value unauthorized';
        document.getElementById('idNumberStatus').textContent = 'N/A';
        document.getElementById('idNumberStatus').className = 'value unauthorized';
        showUnauthorizedStatus();
        return;
    }

    // å…³é”®ä¿®æ”¹ï¼šæ™®é€šéªŒè¯æˆåŠŸæ—¶ï¼Œä¸æ˜¾ç¤ºå…·ä½“å¡å·ä¿¡æ¯
    document.getElementById('cardIdStatus').textContent = 'å·²éªŒè¯';
    document.getElementById('cardIdStatus').className = 'value verified';
    document.getElementById('idNumberStatus').textContent = '***';
    document.getElementById('idNumberStatus').className = 'value verified';

    if (nfcCards[cardId]) {
        const cardData = nfcCards[cardId];
        nfcStatus.textContent = 'âœ… å¡ç‰‡éªŒè¯æˆåŠŸ';
        nfcStatus.style.color = '#4caf50';
        cardInfo.innerHTML = `èº«ä»½ç±»å‹: ${cardData.type}`;
        cardInfo.style.color = '#4caf50';

        // é€æ­¥æ˜¾ç¤ºè®¤è¯ä¿¡æ¯ï¼ˆä½†ä¸æ˜¾ç¤ºå¡å·ï¼‰
        setTimeout(() => {
            document.getElementById('nameStatus').textContent = cardData.name;
            document.getElementById('nameStatus').className = 'value verified';
            loadingProgress.style.width = '40%';
        }, 500);

        setTimeout(() => {
            document.getElementById('affiliationStatus').textContent = cardData.affiliation;
            document.getElementById('affiliationStatus').className = 'value verified';
            loadingProgress.style.width = '60%';
        }, 1000);

        setTimeout(() => {
            document.getElementById('levelStatus').textContent = cardData.level;
            document.getElementById('levelStatus').className = 'value verified';
            loadingProgress.style.width = '80%';
        }, 1500);

        setTimeout(() => {
            document.getElementById('areaStatus').textContent = cardData.area;
            document.getElementById('areaStatus').className = 'value verified';
            loadingProgress.style.width = '100%';
        }, 2000);

    } else {
        nfcStatus.textContent = 'âŒ æœªçŸ¥å¡ç‰‡';
        nfcStatus.style.color = '#f44336';
        cardInfo.innerHTML = 'æœªæˆæƒçš„å¡ç‰‡';
        cardInfo.style.color = '#f44336';
        // å…³é”®ä¿®æ”¹ï¼šå¯¹äºæœªçŸ¥å¡ç‰‡ï¼Œä¹Ÿä¸æ˜¾ç¤ºå…·ä½“å¡å·
        document.getElementById('idNumberStatus').textContent = 'N/A';
        document.getElementById('idNumberStatus').className = 'value unauthorized';
        showUnauthorizedStatus();
    }
}
        // æ˜¾ç¤ºæœªæˆæƒçŠ¶æ€
        function showUnauthorizedStatus() {
            setTimeout(() => {
                document.getElementById('nameStatus').textContent = 'æœªçŸ¥ç”¨æˆ·';
                document.getElementById('nameStatus').className = 'value unauthorized';
                document.getElementById('affiliationStatus').textContent = 'æœªæˆæƒ';
                document.getElementById('affiliationStatus').className = 'value unauthorized';
                document.getElementById('levelStatus').textContent = 'N/A';
                document.getElementById('levelStatus').className = 'value unauthorized';
                document.getElementById('areaStatus').textContent = 'è®¿é—®è¢«æ‹’ç»';
                document.getElementById('areaStatus').className = 'value unauthorized';
                loadingProgress.style.width = '100%';
            }, 1000);
        }

        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        function resetAllStatus() {
            document.getElementById('cardIdStatus').textContent = 'ç­‰å¾…è¯»å–';
            document.getElementById('cardIdStatus').className = 'value checking';
            document.getElementById('idNumberStatus').textContent = 'ç­‰å¾…è¯»å–';
            document.getElementById('idNumberStatus').className = 'value checking';
            document.getElementById('nameStatus').textContent = 'ç­‰å¾…NFCéªŒè¯';
            document.getElementById('nameStatus').className = 'value checking';
            document.getElementById('affiliationStatus').textContent = 'ç­‰å¾…NFCéªŒè¯';
            document.getElementById('affiliationStatus').className = 'value checking';
            document.getElementById('levelStatus').textContent = 'ç­‰å¾…NFCéªŒè¯';
            document.getElementById('levelStatus').className = 'value checking';
            document.getElementById('areaStatus').textContent = 'ç­‰å¾…NFCéªŒè¯';
            document.getElementById('areaStatus').className = 'value checking';
            loadingProgress.style.width = '0%';
            
            // é‡ç½®NFCçŠ¶æ€æ˜¾ç¤º
            document.getElementById('nfcStatus').textContent = 'ç­‰å¾…æ‰«æ...';
            document.getElementById('nfcStatus').style.color = '#ffa726';
            document.getElementById('cardInfo').innerHTML = '';
            document.getElementById('nfcError').textContent = '';
            document.getElementById('manualTestStatus').innerHTML = '';
        }
    </script>
</body>
</html>
    const nfcError = document.getElementById('nfcError');
    
    if (!('NDEFReader' in window)) {
        nfcError.textContent = 'æ­¤æµè§ˆå™¨ä¸æ”¯æŒNFCåŠŸèƒ½';
        return;
    }

    try {
        nfcButton.disabled = true;
        adminNdefReader = new NDEFReader();
        await adminNdefReader.scan();
        
        adminNdefReader.onreading = event => {
            const decoder = new TextDecoder();
            let cardId = '';
            for (const record of event.message.records) {
                if (record.recordType === "text") {
                    cardId = decoder.decode(record.data);
                    break;
                }
            }
            
            if (cardId === ADMIN_KEY) {
                adminVerifiedSuccess();
            } else {
                adminVerificationFailed();
            }
            
            if (adminNdefReader) {
                adminNdefReader.onreading = null;
            }
        };
        
        adminNdefReader.onreadingerror = () => {
            nfcError.textContent = 'è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•';
            nfcButton.disabled = false;
        };
        
    } catch (error) {
        nfcError.textContent = 'NFCæ‰«æå¤±è´¥: ' + error.message;
        nfcButton.disabled = false;
    }
}

// ç®¡ç†å‘˜éªŒè¯æˆåŠŸ
function adminVerifiedSuccess() {
    isAdminVerified = true;
    
    const nfcStatus = document.getElementById('nfcStatus');
    const cardInfo = document.getElementById('cardInfo');
    const nfcButton = document.getElementById('nfcButton');
    
    nfcStatus.textContent = 'âœ… ç®¡ç†å‘˜éªŒè¯æˆåŠŸ';
    nfcStatus.style.color = '#4caf50';
    cardInfo.innerHTML = 'ç®¡ç†å‘˜åå°å·²è§£é”';
    cardInfo.style.color = '#4caf50';
    nfcButton.disabled = false;
    
    // æ˜¾ç¤ºç®¡ç†å‘˜åå°ç•Œé¢
    document.getElementById('adminSection').style.display = 'block';
    document.getElementById('adminVerify').style.display = 'none';
    
    // åŠ è½½å·²å‚¨å­˜å¡ç‰‡åˆ—è¡¨
    displayStoredCards();
    
    // è‡ªåŠ¨å¡«å……ç¤ºä¾‹æ•°æ®
    const nextNum = Object.keys(nfcCards).length + 100;
    document.getElementById('newCardId').value = 'STUDENT-' + nextNum;
    document.getElementById('newName').value = 'æ–°å­¦ç”Ÿï¼štrue';
    document.getElementById('newAffiliation').value = 'é˜¿æ‹œå¤šæ–¯é«˜ç­‰å­¦é™¢ï¼štrue';
    document.getElementById('newLevel').value = 'R-Stdï¼štrue';
    document.getElementById('newArea').value = 'é˜¿æ‹œå¤šæ–¯';
    document.getElementById('newIdNumber').value = 'ABXY-' + nextNum;
}

// æ˜¾ç¤ºå·²å‚¨å­˜å¡ç‰‡åˆ—è¡¨
function displayStoredCards() {
    const listContainer = document.getElementById('storedCardsList');
    if (!listContainer) return;
    
    let html = '';
    for (const [cardId, cardData] of Object.entries(nfcCards)) {
        // è·³è¿‡ç®¡ç†å‘˜å¯†é’¥æœ¬èº«
        if (cardId === ADMIN_KEY) continue;
        html += `<div style="margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed rgba(255,255,255,0.1);">
            <strong style="color:#00b4db">å¡å·:</strong> ${cardId}<br>
            <strong>å§“å:</strong> ${cardData.name}<br>
            <strong>IDå¡å·:</strong> ${cardData.idNumber}
        </div>`;
    }
    listContainer.innerHTML = html || '<div style="color:#888; text-align:center; padding:20px;">æš‚æ— å·²å‚¨å­˜çš„å¡ç‰‡</div>';
}

// ç®¡ç†å‘˜éªŒè¯å¤±è´¥
function adminVerificationFailed() {
    const nfcStatus = document.getElementById('nfcStatus');
    const cardInfo = document.getElementById('cardInfo');
    const nfcButton = document.getElementById('nfcButton');
    
    nfcStatus.textContent = 'âŒ ç®¡ç†å‘˜éªŒè¯å¤±è´¥';
    nfcStatus.style.color = '#f44336';
    cardInfo.innerHTML = 'éç®¡ç†å‘˜å¯†é’¥<br>è¯·ä½¿ç”¨æ­£ç¡®çš„ç®¡ç†å‘˜å¯†é’¥å¡ç‰‡';
    cardInfo.style.color = '#f44336';
    nfcButton.disabled = false;
    
    setTimeout(() => {
        resetAllStatus();
    }, 3000);
}
// é€€å‡ºç®¡ç†å‘˜æ¨¡å¼
function exitAdminMode() {
    isAdminVerified = false;
    document.getElementById('adminSection').style.display = 'none';
    document.getElementById('adminVerify').style.display = 'block';
    resetAllStatus();
}

// æ‰‹åŠ¨æµ‹è¯•ï¼ˆç®¡ç†å‘˜åå°ä¸“ç”¨ï¼‰
function manualTest() {
    const cardId = document.getElementById('manualCardId').value.trim();
    if (!cardId) { 
        document.getElementById('manualTestStatus').innerHTML = '<span style="color:#ff9800">è¯·è¾“å…¥å¡å·</span>';
        return; 
    }
    processNFCCard(cardId);
    document.getElementById('manualTestStatus').innerHTML = `<span style="color:#4caf50">æ­£åœ¨æµ‹è¯•å¡å·: ${cardId}</span>`;
}

// ä¿å­˜æ–°å­¦ç”Ÿæ¡£æ¡ˆ
function saveNewCard() {
    if (!isAdminVerified) {
        alert('è¯·å…ˆéªŒè¯ç®¡ç†å‘˜æƒé™ï¼');
        return;
    }

    const newCardId = document.getElementById('newCardId').value.trim();
    const newName = document.getElementById('newName').value.trim();
    const newAffiliation = document.getElementById('newAffiliation').value.trim();
    const newLevel = document.getElementById('newLevel').value.trim();
    const newArea = document.getElementById('newArea').value.trim();
    const newIdNumber = document.getElementById('newIdNumber').value.trim();

    // éªŒè¯è¾“å…¥
    if (!newCardId || !newName || !newAffiliation || !newLevel || !newArea || !newIdNumber) {
        alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼');
        return;
    }

    if (nfcCards[newCardId]) {
        alert('æ­¤å¡å·å·²å­˜åœ¨ï¼');
        return;
    }

    // æ·»åŠ åˆ°æ•°æ®åº“
    nfcCards[newCardId] = {
        name: newName,
        affiliation: newAffiliation,
        level: newLevel,
        area: newArea,
        idNumber: newIdNumber,
        type: 'å­¦ç”Ÿè®¤è¯'
    };

    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    const saveStatus = document.getElementById('saveStatus');
    saveStatus.innerHTML = `<div style="color:#4caf50; padding:10px; background:rgba(76,175,80,0.1); border-radius:5px;">
        âœ… <strong>æ–°æ¡£æ¡ˆå·²ä¿å­˜ï¼</strong><br>
        å¡å·: <span class="card-id">${newCardId}</span><br>
        è¯·å°†æ­¤å¡å·å†™å…¥NFCæ ‡ç­¾ã€‚
    </div>`;

    // æ›´æ–°æµ‹è¯•æŒ‰é’®å’Œåˆ—è¡¨
    updateTestButtons(newCardId);
    displayStoredCards();

    // è‡ªåŠ¨å¡«å……ä¸‹ä¸€ä¸ªå¡å·
    const nextNum = Object.keys(nfcCards).length + 100;
    document.getElementById('newCardId').value = 'STUDENT-' + nextNum;
    document.getElementById('newName').value = '';
    document.getElementById('newAffiliation').value = '';
    document.getElementById('newLevel').value = '';
    document.getElementById('newArea').value = '';
    document.getElementById('newIdNumber').value = 'ABXY-' + nextNum;
    
    setTimeout(() => {
        saveStatus.innerHTML = '';
    }, 5000);
}

// æ›´æ–°æµ‹è¯•æŒ‰é’®
function updateTestButtons(newCardId) {
    const testButtonsContainer = document.getElementById('testButtonsContainer');
    
    const newButton = document.createElement('button');
    newButton.className = 'test-button';
    newButton.textContent = newCardId.length > 8 ? newCardId.substring(0, 8) + '...' : newCardId;
    newButton.title = newCardId;
    newButton.onclick = function() { 
        testCard(newCardId);
    };
    
    const buttons = testButtonsContainer.querySelectorAll('.test-button');
    const blankButton = Array.from(buttons).find(btn => btn.textContent.includes('ç©ºç™½å¡'));
    if (blankButton) {
        testButtonsContainer.insertBefore(newButton, blankButton);
    } else {
        testButtonsContainer.appendChild(newButton);
    }
}
