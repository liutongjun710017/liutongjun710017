<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«ä»½è®¤è¯ç³»ç»Ÿ - è”é‚¦æ²™å‹’è°ƒæŸ¥å±€</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .lang-btn {
            background: #4a69bd;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            transition: background 0.3s;
        }
        .lang-btn:hover { background: #3c5aa8; }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #4a69bd, #6a89cc);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
        }
        h1 {
            color: #0c2461;
            font-size: 28px;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            font-size: 16px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card-title {
            color: #1e3799;
            font-size: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-title i { font-size: 24px; }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #4a69bd;
            outline: none;
        }
        .btn {
            display: inline-block;
            background: linear-gradient(to right, #4a69bd, #6a89cc);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
        }
        .btn:hover {
            background: linear-gradient(to right, #3c5aa8, #5a7ac2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 105, 189, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(to right, #38ada9, #78e08f);
        }
        .btn-secondary:hover { background: linear-gradient(to right, #2d968f, #64d07a); }
        .btn-danger {
            background: linear-gradient(to right, #e55039, #eb8d6a);
        }
        .btn-danger:hover { background: linear-gradient(to right, #d44029, #e07d5a); }
        .result-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #4a69bd;
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .result-label {
            font-weight: bold;
            color: #555;
        }
        .result-value {
            color: #0c2461;
            font-weight: 500;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #38ada9; }
        .status-warning { background: #f6b93b; }
        .status-error { background: #e55039; }
        .debug-panel {
            background: #f1f2f6;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            border: 1px dashed #a4b0be;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
        <div class="language-switcher">
            <button class="lang-btn" onclick="switchLanguage('en')">English</button>
            <button class="lang-btn" onclick="switchLanguage('zh')">ä¸­æ–‡</button>
        </div>

        <!-- é¡µå¤´ -->
        <div class="header">
            <div class="logo">FBI</div>
            <h1>èº«ä»½è®¤è¯ç³»ç»Ÿ</h1>
            <p class="subtitle">è”é‚¦æ²™å‹’è°ƒæŸ¥å±€ - å®‰å…¨éªŒè¯</p>
        </div>

        <!-- NFC è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
        <div id="nfc-debug-panel" class="card" style="display: none;">
            <div class="card-title">
                <i>ğŸ”</i> NFC è°ƒè¯•ä¿¡æ¯
            </div>
            <p><strong>çŠ¶æ€ï¼š</strong><span id="nfc-status-text">ç­‰å¾…å¼€å§‹</span></p>
            <p><strong>æµè§ˆå™¨ï¼š</strong><span id="browser-info-text">æ£€æµ‹ä¸­...</span></p>
            <p><strong>æœ€åæ“ä½œï¼š</strong><span id="last-action-text">-</span></p>
            <div id="detailed-error" style="color: #d32f2f; margin-top: 10px;"></div>
        </div>

        <!-- ä¸»éªŒè¯å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">
                <i>ğŸ†”</i> èº«ä»½ä¿¡æ¯
            </div>
            <div class="form-group">
                <label for="carId">CAR ID:</label>
                <div class="result-display">
                    <div class="result-item">
                        <span class="result-label">CAR ID:</span>
                        <span id="carIdDisplay" class="result-value">ç­‰å¾…è¯»å–...</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">IDå¡å·:</span>
                        <span id="cardNumberDisplay" class="result-value">N/A</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">å§“å:</span>
                        <span id="nameDisplay" class="result-value">æœªçŸ¥ç”¨æˆ·</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px;">
                <button id="startNFCBtn" class="btn" onclick="startEdgeCompatibleScan()" 
                        style="padding: 18px 40px; font-size: 18px;">
                    ğŸ“± å¼€å§‹NFCæ‰«æ
                </button>
                <button class="btn btn-secondary" onclick="showAdminPanel()" 
                        style="margin-left: 15px; padding: 18px 30px; font-size: 18px;">
                    ğŸ”§ ç®¡ç†å‘˜åå°
                </button>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜é¢æ¿ (é»˜è®¤éšè—) -->
        <div id="adminPanel" class="card hidden">
            <div class="card-title">
                <i>âš™ï¸</i> ç®¡ç†å‘˜åå°
            </div>
            <div class="form-group">
                <label>ç®¡ç†å‘˜å¯†é’¥éªŒè¯</label>
                <input type="password" id="adminKeyInput" placeholder="æ‰«æç®¡ç†å‘˜å¯†é’¥NFCæ ‡ç­¾æˆ–è¾“å…¥å¯†é’¥">
                <button class="btn btn-secondary" onclick="verifyAdminKey()" style="margin-top: 10px;">éªŒè¯å¯†é’¥</button>
            </div>
            
            <div id="adminFunctions" style="display: none;">
                <div class="card" style="background: #f8f9fa;">
                    <div class="card-title"><i>ğŸ“‹</i> å·²å‚¨å­˜å¡ç‰‡åˆ—è¡¨</div>
                    <div id="storedCardsList"></div>
                </div>
                
                <div class="card" style="background: #f8f9fa; margin-top: 20px;">
                    <div class="card-title"><i>ğŸ†•</i> åˆ›å»ºæ–°å¡ç‰‡</div>
                    <div class="form-group">
                        <label>å¡å· (æ ¼å¼: xy 214412):</label>
                        <input type="text" id="newCardNumber" placeholder="ä¾‹å¦‚: xy 214412">
                    </div>
                    <div class="form-group">
                        <label>æŒå¡äººå§“å:</label>
                        <input type="text" id="newCardName" placeholder="ä¾‹å¦‚: å­¦ç”Ÿ">
                    </div>
                    <div class="form-group">
                        <label>å¡ç‰‡ç±»å‹:</label>
                        <select id="newCardType">
                            <option value="student">å­¦ç”Ÿå¡</option>
                            <option value="sensei">Senseiå¡</option>
                            <option value="admin">ç®¡ç†å‘˜å¯†é’¥å¡</option>
                        </select>
                    </div>
                    <button class="btn" onclick="createNewCard()">åˆ›å»ºæ–°å¡ç‰‡</button>
                    <button class="btn btn-secondary" onclick="writeToNFCTag()" style="margin-left: 10px;">å†™å…¥NFCæ ‡ç­¾</button>
                </div>
                
                <div class="card" style="background: #f8f9fa; margin-top: 20px;">
                    <div class="card-title"><i>ğŸ§ª</i> æ‰‹åŠ¨æµ‹è¯•</div>
                    <div class="form-group">
                        <label>æ‰‹åŠ¨è¾“å…¥å¡å·æµ‹è¯•:</label>
                        <input type="text" id="manualCardInput" placeholder="è¾“å…¥å¡å·è¿›è¡Œæµ‹è¯•">
                    </div>
                    <button class="btn" onclick="manualTestCard()">æµ‹è¯•éªŒè¯</button>
                </div>
            </div>
        </div>

        <!-- ç‰©ç†å¡ç‰‡æç¤ºåŒºåŸŸï¼ˆæ›¿ä»£åŸæ¥çš„æ¨¡æ‹Ÿå¡ç‰‡åŒºåŸŸï¼‰ -->
        <div class="card">
            <div class="card-title">
                <i>ğŸ’³</i> ä½¿ç”¨è¯´æ˜
            </div>
            <div style="text-align: center; padding: 20px;">
                <p style="margin-bottom: 15px; font-size: 16px;">
                    <strong>âš ï¸ æœ¬ç³»ç»Ÿä»…æ”¯æŒç‰©ç†NFCå¡ç‰‡éªŒè¯</strong>
                </p>
                <p style="color: #666; margin-bottom: 10px;">
                    1. è¯·ç¡®ä¿ä½¿ç”¨æ”¯æŒNFCçš„Androidè®¾å¤‡<br>
                    2. ç‚¹å‡»"å¼€å§‹NFCæ‰«æ"æŒ‰é’®æˆæƒNFCæƒé™<br>
                    3. å°†ç‰©ç†NFCå¡ç‰‡è´´è¿‘è®¾å¤‡èƒŒé¢è¿›è¡ŒéªŒè¯<br>
                    4. ç³»ç»Ÿä¸æ”¯æŒæ¨¡æ‹Ÿå¡ç‰‡æˆ–ç‚¹å‡»éªŒè¯
                </p>
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-top: 15px;">
                    <p style="color: #0c2461; margin: 0;">
                        <strong>æ”¯æŒçš„å¡ç‰‡ç±»å‹ï¼š</strong><br>
                        â€¢ Senseiå¡ (se 710017)<br>
                        â€¢ å­¦ç”Ÿå¡ (xy 214412)<br>
                        â€¢ ç®¡ç†å‘˜å¯†é’¥å¡
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let nfcReader = null;
        let isScanning = false;
        let currentLanguage = 'zh';
        let storedCards = {
            "se 710017": { name: "Sensei", type: "sensei", fullNumber: "se 710017" },
            "xy 214412": { name: "å­¦ç”Ÿ", type: "student", fullNumber: "xy 214412" },
            "ADM-001710017ndbhcihbsnvdhdbscjsbsbsbjdhdcnsbbkbhdbjxvnsshjfsbbevdjhdbwkbwgdugdkeb": { 
                name: "ç®¡ç†å‘˜å¯†é’¥", 
                type: "admin", 
                fullNumber: "ADM-001710017ndbhcihbsnvdhdbscjsbsbsbjdhdcnsbbkbhdbjxvnsshjfsbbevdjhdbwkbwgdugdkeb"
            }
        };

        // è¯­è¨€åˆ‡æ¢
        function switchLanguage(lang) {
            currentLanguage = lang;
            const texts = {
                zh: {
                    title: "èº«ä»½è®¤è¯ç³»ç»Ÿ",
                    subtitle: "è”é‚¦æ²™å‹’è°ƒæŸ¥å±€ - å®‰å…¨éªŒè¯",
                    startScan: "ğŸ“± å¼€å§‹NFCæ‰«æ",
                    adminPanel: "ğŸ”§ ç®¡ç†å‘˜åå°",
                    carId: "CAR ID:",
                    cardNumber: "IDå¡å·:",
                    name: "å§“å:",
                    waiting: "ç­‰å¾…è¯»å–...",
                    unknown: "æœªçŸ¥ç”¨æˆ·",
                    instructionsTitle: "ä½¿ç”¨è¯´æ˜",
                    instructionsText: "æœ¬ç³»ç»Ÿä»…æ”¯æŒç‰©ç†NFCå¡ç‰‡éªŒè¯",
                    instructionsList1: "1. è¯·ç¡®ä¿ä½¿ç”¨æ”¯æŒNFCçš„Androidè®¾å¤‡",
                    instructionsList2: "2. ç‚¹å‡»\"å¼€å§‹NFCæ‰«æ\"æŒ‰é’®æˆæƒNFCæƒé™",
                    instructionsList3: "3. å°†ç‰©ç†NFCå¡ç‰‡è´´è¿‘è®¾å¤‡èƒŒé¢è¿›è¡ŒéªŒè¯",
                    instructionsList4: "4. ç³»ç»Ÿä¸æ”¯æŒæ¨¡æ‹Ÿå¡ç‰‡æˆ–ç‚¹å‡»éªŒè¯",
                    supportedCards: "æ”¯æŒçš„å¡ç‰‡ç±»å‹ï¼š"
                },
                en: {
                    title: "Identity Authentication System",
                    subtitle: "Federal Bureau of Investigation - Secure Verification",
                    startScan: "ğŸ“± Start NFC Scan",
                    adminPanel: "ğŸ”§ Admin Panel",
                    carId: "CAR ID:",
                    cardNumber: "Card Number:",
                    name: "Name:",
                    waiting: "Waiting for read...",
                    unknown: "Unknown User",
                    instructionsTitle: "Instructions",
                    instructionsText: "This system only supports physical NFC card verification",
                    instructionsList1: "1. Please use an Android device with NFC support",
                    instructionsList2: "2. Click \"Start NFC Scan\" button to authorize NFC permission",
                    instructionsList3: "3. Place the physical NFC card close to the back of the device",
                    instructionsList4: "4. The system does not support simulated cards or click verification",
                    supportedCards: "Supported Card Types:"
                }
            };
            
            const t = texts[lang];
            document.querySelector('h1').textContent = t.title;
            document.querySelector('.subtitle').textContent = t.subtitle;
            document.getElementById('startNFCBtn').textContent = t.startScan;
            document.querySelector('button[onclick="showAdminPanel()"]').textContent = t.adminPanel;
            document.querySelectorAll('.result-item')[0].querySelector('.result-label').textContent = t.carId;
            document.querySelectorAll('.result-item')[1].querySelector('.result-label').textContent = t.cardNumber;
            document.querySelectorAll('.result-item')[2].querySelector('.result-label').textContent = t.name;
            
            // æ›´æ–°ä½¿ç”¨è¯´æ˜åŒºåŸŸ
            const instructionsCard = document.querySelector('.card:last-child .card-title');
            if (instructionsCard) {
                instructionsCard.innerHTML = `<i>ğŸ’³</i> ${t.instructionsTitle}`;
                const instructionsContent = document.querySelector('.card:last-child div[style*="text-align: center"]');
                if (instructionsContent) {
                    const paragraphs = instructionsContent.querySelectorAll('p');
                    if (paragraphs[0]) paragraphs[0].innerHTML = `<strong>âš ï¸ ${t.instructionsText}</strong>`;
                    if (paragraphs[1]) paragraphs[1].innerHTML = `
                        ${t.instructionsList1}<br>
                        ${t.instructionsList2}<br>
                        ${t.instructionsList3}<br>
                        ${t.instructionsList4}
                    `;
                    const supportedCardsDiv = instructionsContent.querySelector('div[style*="background: #f8f9fa"]');
                    if (supportedCardsDiv && supportedCardsDiv.querySelector('p')) {
                        supportedCardsDiv.querySelector('p').innerHTML = `<strong>${t.supportedCards}</strong><br>
                        â€¢ Senseiå¡ (se 710017)<br>
                        â€¢ å­¦ç”Ÿå¡ (xy 214412)<br>
                        â€¢ ç®¡ç†å‘˜å¯†é’¥å¡`;
                    }
                }
            }
            
            if(document.getElementById('carIdDisplay').textContent === 'ç­‰å¾…è¯»å–...') {
                document.getElementById('carIdDisplay').textContent = t.waiting;
            }
            if(document.getElementById('nameDisplay').textContent === 'æœªçŸ¥ç”¨æˆ·') {
                document.getElementById('nameDisplay').textContent = t.unknown;
            }
        }

        // === æ ¸å¿ƒä¿®å¤ï¼šEdgeå…¼å®¹çš„NFCæ‰«æå‡½æ•° ===
        async function startEdgeCompatibleScan() {
            const statusEl = document.getElementById('nfc-status-text');
            const browserInfoEl = document.getElementById('browser-info-text');
            const lastActionEl = document.getElementById('last-action-text');
            const errorEl = document.getElementById('detailed-error');
            const debugPanel = document.getElementById('nfc-debug-panel');
            
            // æ˜¾ç¤ºè°ƒè¯•é¢æ¿
            debugPanel.style.display = 'block';
            errorEl.innerHTML = '';
            statusEl.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
            lastActionEl.textContent = `å¼€å§‹è¯·æ±‚ NFC æƒé™`;
            
            // æ£€æµ‹æµè§ˆå™¨å’Œç³»ç»Ÿ
            const ua = navigator.userAgent;
            const isEdge = ua.includes('Edg');
            const isAndroid = ua.includes('Android');
            const isChrome = ua.includes('Chrome') && !ua.includes('Edg');
            
            let browserInfo = '';
            if (isEdge) {
                const edgeVersion = ua.match(/Edg\/(\d+)/);
                browserInfo = `Microsoft Edge (${edgeVersion ? edgeVersion[1] : '?'})`;
            } else if (isChrome) {
                browserInfo = 'Google Chrome';
            } else {
                browserInfo = 'å…¶ä»–æµè§ˆå™¨';
            }
            browserInfoEl.textContent = `${browserInfo} | ${isAndroid ? 'Android' : 'éAndroid'}`;
            
            // 1. æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Web NFC
            if (!('NDEFReader' in window)) {
                const msg = 'âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web NFC APIã€‚<br>è¯·ä½¿ç”¨ Android è®¾å¤‡çš„ Edge æˆ– Chrome æµè§ˆå™¨è®¿é—®æ­¤é¡µé¢ã€‚';
                statusEl.innerHTML = msg;
                errorEl.innerHTML = `<p>${msg}</p><p>ç”¨æˆ·ä»£ç†: ${ua}</p>`;
                return;
            }
            
            // 2. æ£€æŸ¥æ˜¯å¦åœ¨ HTTPS æˆ– localhost
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                const msg = 'âš ï¸ Web NFC éœ€è¦ HTTPS å®‰å…¨è¿æ¥ã€‚<br>ä½ çš„ GitHub Pages å·²è‡ªåŠ¨ä½¿ç”¨ HTTPSï¼Œè¯·æ£€æŸ¥åœ°å€æ æ˜¯å¦æœ‰ ğŸ”’ å›¾æ ‡ã€‚';
                statusEl.innerHTML = msg;
                return;
            }
            
            try {
                // 3. åˆ›å»ºæˆ–å¤ç”¨ NDEFReader å®ä¾‹ï¼ˆå…³é”®ï¼é¿å…é‡å¤è¯·æ±‚æƒé™ï¼‰
                if (!nfcReader) {
                    console.log("åˆ›å»ºæ–°çš„ NDEFReader å®ä¾‹...");
                    nfcReader = new NDEFReader();
                    
                    // å®šä¹‰è¯»å–åˆ°å¡ç‰‡åçš„å¤„ç†é€»è¾‘
                    nfcReader.onreading = (event) => {
                        console.log("âœ… NFC è¯»å–æˆåŠŸï¼", event);
                        lastActionEl.textContent = `å¡ç‰‡è¯»å–æˆåŠŸ ${new Date().toLocaleTimeString()}`;
                        handleNFCMessage(event);
                    };
                    
                    nfcReader.onreadingerror = (err) => {
                        console.warn("è¯»å–é”™è¯¯ï¼š", err);
                        lastActionEl.textContent = `è¯»å–é”™è¯¯ ${new Date().toLocaleTimeString()}`;
                        statusEl.textContent = 'âŒ è¯»å–å¤±è´¥ï¼Œè¯·é‡æ–°å°è¯•';
                    };
                }
                
                // 4. å¼€å§‹æ‰«æï¼ˆè¿™ä¼šè§¦å‘ç³»ç»Ÿæƒé™å¼¹çª—ï¼‰
                statusEl.textContent = 'è¯·åœ¨å¼¹å‡ºçš„ç³»ç»Ÿå¯¹è¯æ¡†ä¸­ç‚¹å‡»"å…è®¸"...';
                lastActionEl.textContent = `è°ƒç”¨ scan() æ–¹æ³• ${new Date().toLocaleTimeString()}`;
                
                // é‡è¦ï¼šEdge/Chrome éœ€è¦æ˜ç¡®çš„ç”¨æˆ·æ‰‹åŠ¿ï¼Œè¿™é‡Œå·²ç»æœ‰äº†ï¼ˆæŒ‰é’®ç‚¹å‡»ï¼‰
                await nfcReader.scan();
                
                // 5. å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ç”¨æˆ·å·²æˆäºˆæƒé™
                isScanning = true;
                statusEl.innerHTML = 'âœ… <strong>æ‰«æå·²å¼€å§‹ï¼</strong> è¯·å°†å¡ç‰‡è´´è¿‘è®¾å¤‡èƒŒé¢ã€‚';
                lastActionEl.textContent = `æƒé™å·²æˆäºˆï¼Œæ‰«æè¿›è¡Œä¸­ ${new Date().toLocaleTimeString()}`;
                
                // 6. 30ç§’åè‡ªåŠ¨åœæ­¢æ‰«æï¼Œé¿å…æŒç»­å ç”¨
                setTimeout(async () => {
                    if (nfcReader && isScanning) {
                        try {
                            await nfcReader.stop();
                            isScanning = false;
                            statusEl.innerHTML = 'â¹ï¸ <strong>æ‰«æå·²è‡ªåŠ¨åœæ­¢</strong>ï¼Œå¦‚éœ€å†æ¬¡æ‰«æè¯·ç‚¹å‡»æŒ‰é’®ã€‚';
                            lastActionEl.textContent = `è‡ªåŠ¨åœæ­¢æ‰«æ ${new Date().toLocaleTimeString()}`;
                        } catch (e) { 
                            console.log("åœæ­¢æ‰«ææ—¶çš„å°é”™è¯¯:", e);
                        }
                    }
                }, 30000);
                
            } catch (error) {
                console.error("NFC æ‰«æå¤±è´¥ï¼š", error);
                isScanning = false;
                statusEl.innerHTML = 'âŒ <strong>æ‰«æå¯åŠ¨å¤±è´¥</strong>';
                lastActionEl.textContent = `æ•è·åˆ°å¼‚å¸¸ ${new Date().toLocaleTimeString()}`;
                
                // ç»™ç”¨æˆ·çœ‹çš„å‹å¥½é”™è¯¯æç¤º
                let userFriendlyMsg = '';
                if (error.name === 'NotAllowedError') {
                    userFriendlyMsg = `æƒé™è¯·æ±‚è¢«æ‹’ç»ã€‚<br><strong>è¯·åˆ·æ–°é¡µé¢åé‡è¯•ï¼Œå¹¶åœ¨ç³»ç»Ÿå¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ç‚¹å‡»"å…è®¸"ã€‚</strong><br><br>
                    å¦‚æœé—®é¢˜ä¾æ—§ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æ£€æŸ¥æ­¤ç½‘ç«™çš„NFCæƒé™ï¼š<br>
                    1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„ ğŸ”’ æˆ– â“˜ å›¾æ ‡<br>
                    2. é€‰æ‹©"ç½‘ç«™è®¾ç½®"æˆ–"æƒé™"<br>
                    3. æ‰¾åˆ°"NFC"é€‰é¡¹å¹¶è®¾ç½®ä¸º"å…è®¸"`;
                } else if (error.name === 'NotSupportedError') {
                    userFriendlyMsg = `è®¾å¤‡ä¸æ”¯æŒNFCåŠŸèƒ½ã€‚<br>è¯·ç¡®ä¿ï¼š<br>
                    1. ä½¿ç”¨ Android æ‰‹æœº<br>
                    2. æ‰‹æœºç³»ç»Ÿå·²å¼€å¯NFCåŠŸèƒ½<br>
                    3. ä½¿ç”¨ Edge æˆ– Chrome æµè§ˆå™¨`;
                } else if (error.message.includes('User cancelled')) {
                    userFriendlyMsg = 'æ‚¨å–æ¶ˆäº†æƒé™è¯·æ±‚ã€‚';
                } else {
                    userFriendlyMsg = `é”™è¯¯: ${error.message || error.name}`;
                }
                
                errorEl.innerHTML = `<p>${userFriendlyMsg}</p><p>é”™è¯¯è¯¦æƒ…: ${error.name}</p>`;
            }
        }

        // å¤„ç†NFCè¯»å–åˆ°çš„æ¶ˆæ¯
        function handleNFCMessage(event) {
            const decoder = new TextDecoder();
            for (const record of event.message.records) {
                if (record.recordType === "text") {
                    const textData = decoder.decode(record.data);
                    console.log("è¯»å–åˆ°æ–‡æœ¬æ•°æ®:", textData);
                    processCardData(textData.trim());
                    
                    // è¯»å–æˆåŠŸåè‡ªåŠ¨åœæ­¢æ‰«æ
                    if (nfcReader && isScanning) {
                        nfcReader.stop().catch(() => {});
                        isScanning = false;
                        document.getElementById('nfc-status-text').textContent = 'âœ… è¯»å–å®Œæˆï¼Œæ‰«æå·²åœæ­¢';
                    }
                    break;
                }
            }
        }

        // å¤„ç†å¡ç‰‡æ•°æ®
        function processCardData(cardData) {
            console.log("å¤„ç†å¡ç‰‡æ•°æ®:", cardData);
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('carIdDisplay').textContent = "å·²éªŒè¯";
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜å¯†é’¥ï¼ˆé•¿å­—ç¬¦ä¸²ï¼‰
            if (cardData.length > 50) {
                document.getElementById('cardNumberDisplay').textContent = "*** (ç®¡ç†å‘˜å¯†é’¥)";
                document.getElementById('nameDisplay').textContent = "ç®¡ç†å‘˜";
                return;
            }
            
            // æ™®é€šå¡ç‰‡å¤„ç†
            const cardInfo = storedCards[cardData];
            if (cardInfo) {
                // å‰å°æ™®é€šéªŒè¯ï¼šéšè—å®Œæ•´å¡å·
                document.getElementById('cardNumberDisplay').textContent = "***";
                document.getElementById('nameDisplay').textContent = cardInfo.name;
            } else {
                document.getElementById('cardNumberDisplay').textContent = "æœªçŸ¥å¡å·";
                document.getElementById('nameDisplay').textContent = "æœªæ³¨å†Œç”¨æˆ·";
            }
            
            // å¦‚æœæ­£åœ¨æ˜¾ç¤ºç®¡ç†å‘˜åå°ï¼Œåˆ™æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
            if (document.getElementById('adminFunctions').style.display !== 'none') {
                document.getElementById('cardNumberDisplay').textContent = cardData;
                if (cardInfo) {
                    document.getElementById('nameDisplay').textContent = `${cardInfo.name} (${cardInfo.type})`;
                }
            }
        }

        // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
        function showAdminPanel() {
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        // éªŒè¯ç®¡ç†å‘˜å¯†é’¥
        function verifyAdminKey() {
            const inputKey = document.getElementById('adminKeyInput').value.trim();
            const adminKey = "ADM-001710017ndbhcihbsnvdhdbscjsbsbsbjdhdcnsbbkbhdbjxvnsshjfsbbevdjhdbwkbwgdugdkeb";
            
            if (inputKey === adminKey) {
                document.getElementById('adminFunctions').style.display = 'block';
                updateStoredCardsList();
                alert("âœ… ç®¡ç†å‘˜æƒé™éªŒè¯æˆåŠŸï¼");
            } else {
                alert("âŒ ç®¡ç†å‘˜å¯†é’¥é”™è¯¯ï¼");
            }
        }

        // æ›´æ–°å·²å‚¨å­˜å¡ç‰‡åˆ—è¡¨
        function updateStoredCardsList() {
            const listEl = document.getElementById('storedCardsList');
            listEl.innerHTML = '';
            
            for (const [cardNumber, cardInfo] of Object.entries(storedCards)) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'result-item';
                cardDiv.innerHTML = `
                    <div>
                        <strong>${cardInfo.name}</strong><br>
                        <small>å¡å·: ${cardNumber}</small>
                    </div>
                    <div>
                        <span class="status-indicator ${cardInfo.type === 'admin' ? 'status-error' : 'status-success'}"></span>
                        ${cardInfo.type}
                    </div>
                `;
                listEl.appendChild(cardDiv);
            }
        }

        // åˆ›å»ºæ–°å¡ç‰‡
        function createNewCard() {
            const cardNumber = document.getElementById('newCardNumber').value.trim();
            const cardName = document.getElementById('newCardName').value.trim();
            const cardType = document.getElementById('newCardType').value;
            
            if (!cardNumber || !cardName) {
                alert("è¯·è¾“å…¥å¡å·å’Œå§“åï¼");
                return;
            }
            
            storedCards[cardNumber] = {
                name: cardName,
                type: cardType,
                fullNumber: cardNumber
            };
            
            updateStoredCardsList();
            document.getElementById('newCardNumber').value = '';
            document.getElementById('newCardName').value = '';
            alert(`âœ… å¡ç‰‡åˆ›å»ºæˆåŠŸ: ${cardName} (${cardNumber})`);
        }

        // å†™å…¥NFCæ ‡ç­¾
        async function writeToNFCTag() {
            const cardNumber = document.getElementById('newCardNumber').value.trim();
            
            if (!cardNumber) {
                alert("è¯·å…ˆè¾“å…¥è¦å†™å…¥çš„å¡å·ï¼");
                return;
            }
            
            if (!('NDEFReader' in window)) {
                alert("æµè§ˆå™¨ä¸æ”¯æŒNFCå†™å…¥åŠŸèƒ½");
                return;
            }
            
            try {
                const ndef = new NDEFReader();
                await ndef.write({
                    records: [{ recordType: "text", data: cardNumber }]
                });
                alert(`âœ… NFCæ ‡ç­¾å†™å…¥æˆåŠŸ: ${cardNumber}`);
            } catch (error) {
                console.error("å†™å…¥å¤±è´¥:", error);
                alert(`âŒ NFCæ ‡ç­¾å†™å…¥å¤±è´¥: ${error.message}`);
            }
        }

        // æ‰‹åŠ¨æµ‹è¯•å¡ç‰‡ï¼ˆç®¡ç†å‘˜åå°åŠŸèƒ½ï¼‰
        function manualTestCard() {
            const cardNumber = document.getElementById('manualCardInput').value.trim();
            if (cardNumber) {
                processCardData(cardNumber);
                document.getElementById('nfc-status-text').textContent = 'âœ… æ‰‹åŠ¨æµ‹è¯•å®Œæˆ';
            } else {
                alert("è¯·è¾“å…¥å¡å·è¿›è¡Œæµ‹è¯•");
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log("èº«ä»½è®¤è¯ç³»ç»ŸåŠ è½½å®Œæˆ");
            // é»˜è®¤æ˜¾ç¤ºä¸­æ–‡ç•Œé¢
            switchLanguage('zh');
            
            // åˆå§‹åŒ–NFCè°ƒè¯•é¢æ¿
            const debugPanel = document.getElementById('nfc-debug-panel');
            const ua = navigator.userAgent;
            const isEdge = ua.includes('Edg');
            document.getElementById('browser-info-text').textContent = 
                isEdge ? 'Microsoft Edge' : 'Chrome/å…¶ä»–æµè§ˆå™¨';
        });
    </script>
</body>
</html>
